<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phả Hệ - Phan Đức Chi Hai Phái Nhì</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --red-dark: #8b0000; --gold: #d4af37; --bg: #fdfaf6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); }

     /* Định dạng Banner đồng nhất cho toàn bộ website */
.banner-container {
    width: 100%;
    max-height: 350px; /* Khớp với trang index và lich-su */
    overflow: hidden;
    background-color: #8b0000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.banner-image {
    width: 100%;
    height: auto; /* Để ảnh tự động co giãn theo chiều rộng */
    object-fit: cover;
    display: block;
}

        /* Menu Navbar */
        .navbar { 
            background: var(--red-dark); 
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            border-bottom: 4px solid var(--gold); 
        }
        .navbar a { 
            color: white; 
            text-decoration: none; 
            padding: 15px 25px; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-size: 14px; 
            transition: 0.3s;
        }
        .navbar a:hover { background: rgba(255,255,255,0.15); color: var(--gold); }
        .navbar a.active { color: var(--gold); border-bottom: 2px solid var(--gold); }

        /* --- KHÔI PHỤC STYLE CÂY PHẢ HỆ --- */
        #tree-display { 
            width: 95%; 
            height: 750px; 
            margin: 30px auto; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            overflow: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .node circle { fill: #fff; stroke-width: 2.5px; }
        .node-male circle { stroke: var(--red-dark); } /* Màu đỏ cho Nam */
        .node-female circle { stroke: #ff69b4; } /* Màu hồng cho Nữ/Vợ */
        .node text { font-size: 14px; font-weight: bold; fill: #333; }
        .link { fill: none; stroke: #ccc; stroke-width: 1.5px; stroke-opacity: 0.6; }

        .section-header { text-align: center; color: var(--red-dark); margin-top: 30px; font-size: 1.8rem; }
    </style>
</head>
<body>

    <div class="banner-container">
        <img src="image4.jpg" alt="Nhà thờ họ Phan Đức" class="banner-image">
    </div>

    <nav class="navbar">
        <a href="index.html">Trang Chủ</a> 
        <a href="lich-su.html">Lịch Sử</a>
        <a href="pha-he.html" class="active">Phả Đồ</a> 
        <a href="an-tang.html">Thờ Phụng & An Táng</a>
        <a href="ngay-gio.html">Ngày Giỗ & Kỵ</a>
        <a href="tin-tuc.html">Tin Tức</a>
        <a href="dong-gop.html">Đóng Góp</a>
    </nav>

    <h2 class="section-header">Sơ đồ Phả hệ Chi Hai - Phái Nhì</h2>
    
    <div id="tree-display"></div>

    <script>
        const SHEET_ID = "1H5Gi3MXAD6p9tywPmaiz4awtuETRKtK03cR_-bXeLVU";
        const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/giapha1`;

        async function initTree() {
            try {
                const res = await fetch(API_URL);
                const rawData = await res.json();

                // Chuẩn hóa dữ liệu
                const data = rawData.map(d => ({
                    id: String(d.ID || "").trim(),
                    parentId: String(d.Cha_ID || d.cha || "").trim(),
                    name: (d.Ho_va_Ten || d.ten || "Chưa rõ").trim(),
                    isWife: String(d.ID).toUpperCase().endsWith('W')
                })).filter(d => d.id !== "");

                // Xử lý để luôn có 1 gốc duy nhất (Cụ Phan Đức Mưu)
                let rootId = data[0].id;
                const finalData = data.map((d, index) => {
                    if (index === 0) d.parentId = null;
                    else if (d.parentId === "0" || d.parentId === "") d.parentId = rootId;
                    return d;
                });

                renderD3(finalData);
            } catch (e) { console.error("Lỗi vẽ cây:", e); }
        }

        function renderD3(data) {
            const container = document.getElementById('tree-display');
            const width = Math.max(container.offsetWidth, 1200);
            const height = data.length * 50 + 200;

            const svg = d3.select("#tree-display").append("svg")
                .attr("width", width).attr("height", height)
                .append("g").attr("transform", "translate(150, 50)");

            const stratify = d3.stratify().id(d => d.id).parentId(d => d.parentId);
            const root = stratify(data);
            const treeLayout = d3.tree().size([height - 100, width - 400]);
            treeLayout(root);

            // Vẽ đường nối
            svg.selectAll(".link").data(root.links()).enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

            // Vẽ các nút
            const node = svg.selectAll(".node").data(root.descendants()).enter().append("g")
                .attr("class", d => `node ${d.data.isWife ? 'node-female' : 'node-male'}`)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            node.append("circle").attr("r", 7);
            node.append("text")
                .attr("dy", "0.35em")
                .attr("x", d => d.children ? -15 : 15)
                .style("text-anchor", d => d.children ? "end" : "start")
                .text(d => (d.data.isWife ? "(Bà) " : "Ông ") + d.data.name);
        }

        initTree();
    </script>
</body>
</html>


