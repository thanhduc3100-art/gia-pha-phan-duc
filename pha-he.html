<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Phả Hệ Trực Tuyến - Phan Đức</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* CSS dành riêng cho sơ đồ D3 */
        #tree-display {
            width: 100%;
            overflow-x: auto;
            background-color: #fdfcf0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .node circle {
            fill: #fff;
            stroke-width: 3px;
        }
        .node text {
            font: 14px sans-serif;
            font-weight: bold;
        }
        .link {
            fill: none;
            stroke: #8b0000;
            stroke-width: 2px;
        }
    </style>
</head>
<body>

<div class="banner-container">
    <img src="image4.jpg" alt="Nhà thờ họ Phan Đức" class="banner-image">
</div>

<nav class="navbar">
    <a href="index.html">TRANG CHỦ</a>
    <a href="lich-su.html">LỊCH SỬ</a>
    <a href="pha-he.html" class="active">PHẢ ĐỒ</a>
    <a href="thu-vien-anh.html">THƯ VIỆN ẢNH</a>
    <div class="dropdown">
        <button class="dropbtn">THỜ PHỤNG & AN TÁNG ▼</button>
        <div class="dropdown-content">
            <a href="tho-phung.html">NƠI THỜ PHỤNG</a>
            <a href="khu-mo.html">KHU MỘ GIA TỘC</a>
        </div>
    </div>
    <a href="ngay-gio.html">NGÀY GIỖ & KỴ</a>
</nav>

<div class="content-section">
    <h1 style="text-align: center; color: var(--red-dark); margin-top: 30px;">SƠ ĐỒ PHẢ HỆ CHI HAI - PHÁI NHÌ</h1>
    <p style="text-align: center; font-style: italic; color: #666;">(Dùng chuột hoặc ngón tay để kéo ngang/dọc xem toàn bộ cây)</p>
    
    <div id="tree-display"></div>
</div>

<script>
    const SHEET_ID = "1H5Gi3MXAD6p9tywPmaiz4awtuETRKtK03cR_-bXeLVU";
    const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/giapha1`;

    async function initTree() {
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();

            // 1. Chuyển đổi dữ liệu và làm sạch
            const data = rawData.map(d => ({
                id: String(d.ID || "").trim(),
                parentId: String(d.Cha_ID || "").trim(),
                name: (d.Ho_va_Ten || "Chưa rõ").trim(),
                isWife: String(d.ID).toUpperCase().endsWith('W')
            })).filter(d => d.id !== "");

            // 2. Tìm danh sách tất cả ID đang có
            const allIds = new Set(data.map(d => d.id));

            // 3. Xử lý logic Cha-Con để tránh lỗi sập sơ đồ
            data.forEach(d => {
                // Nếu Cha_ID không tồn tại trong danh sách ID, thì coi như người này là cụ tổ (Gốc)
                if (d.parentId === "" || d.parentId === "0" || !allIds.has(d.parentId)) {
                    d.parentId = null; 
                }
                // Ngăn lỗi một người tự làm cha chính mình
                if (d.parentId === d.id) d.parentId = null;
            });

            // 4. Sắp xếp để cụ tổ lên đầu
            data.sort((a, b) => (a.parentId === null ? -1 : 1));

            renderD3(data);
        } catch (e) { 
            console.error("Lỗi chi tiết:", e); 
            document.getElementById('tree-display').innerHTML = 
                `<p style='text-align:center; color:red;'>Dữ liệu đã thông nhưng chưa vẽ được. <br> Lỗi: ${e.message}</p>`;
        }
    }

    function renderD3(data) {
        const container = document.getElementById('tree-display');
        const width = 2000; // Độ rộng rộng rãi để không bị chồng chữ
        const height = data.length * 40 + 200;

        // Xóa sơ đồ cũ nếu có
        d3.select("#tree-display").selectAll("*").remove();

        const svg = d3.select("#tree-display").append("svg")
            .attr("width", width).attr("height", height)
            .append("g").attr("transform", "translate(150, 50)");

        // Tạo cấu trúc cây từ dữ liệu phẳng
        const root = d3.stratify()
            .id(d => d.id)
            .parentId(d => d.parentId)(data);

        const treeLayout = d3.tree().size([height - 100, width - 600]);
        treeLayout(root);

        // Vẽ đường nối
        svg.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

        // Vẽ các nút
        const node = svg.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.y},${d.x})`);

        // Vòng tròn giới tính
        node.append("circle")
            .attr("r", 6)
            .style("stroke", d => d.data.isWife ? "#ff69b4" : "#8b0000")
            .style("fill", "#fff");

        // Tên thành viên
        node.append("text")
            .attr("dy", ".35em")
            .attr("x", d => d.children ? -15 : 15)
            .attr("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.name)
            .style("fill", d => d.data.isWife ? "#c71585" : "#333");
    }

    // LỆNH QUAN TRỌNG: Chạy hàm khởi tạo cây khi trang web load xong
    initTree();
</script>

</body>
</html>

