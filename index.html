<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia Phả Phan Đức - Chi Hai Phái Nhì</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f4f4f4; }
        header { background: #8b0000; color: white; padding: 15px; text-align: center; }
        #status-log { padding: 10px; color: #666; font-size: 13px; text-align: center; }
        #tree-container { width: 100%; height: 85vh; background: white; border-top: 1px solid #ddd; overflow: auto; }
        .node circle { fill: #fff; stroke: #8b0000; stroke-width: 2.5px; }
        .node text { font-size: 14px; font-weight: bold; }
        .link { fill: none; stroke: #ccc; stroke-width: 2px; }
        .error-box { margin: 50px; padding: 20px; border: 2px dashed red; color: red; background: #fff5f5; border-radius: 8px; }
    </style>
</head>
<body>

<header><h1>Gia Phả Phan Đức - Chi Hai Phái Nhì</h1></header>
<div id="status-log">Đang tải dữ liệu từ Google Sheets...</div>
<div id="tree-container"></div>

<script>
    const SHEET_ID = "1H5Gi3MXAD6p9tywPmaiz4awtuETRKtK03cR_-bXeLVU";
    const SHEET_NAME = "giapha1"; 
    const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

    async function init() {
        const log = document.getElementById('status-log');
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();

            // KIỂM TRA 1: Dữ liệu có phải là danh sách không?
            if (!Array.isArray(rawData)) {
                log.innerHTML = "❌ Lỗi: Không thể đọc danh sách thành viên.";
                showError(`Lỗi từ hệ thống: ${JSON.stringify(rawData)}. <br><br> <b>Cách sửa:</b> Hãy kiểm tra xem tên Tab ở dưới cùng file Google Sheets có đúng là <b>giapha1</b> chưa?`);
                return;
            }

            log.innerHTML = `✅ Đã tải ${rawData.length} thành viên. Đang vẽ phả đồ...`;

            // KIỂM TRA 2: Chuẩn hóa dữ liệu cột
            const data = rawData.map(d => ({
                id: String(d.ID || d.id || "").trim(),
                parentId: String(d.Cha_ID || d.cha_id || d.cha || "0").trim(),
                name: d.Ho_va_Ten || d.ho_va_ten || d.ten || "Chưa có tên"
            })).filter(d => d.id !== "");

            renderTree(data);
            log.innerHTML = `✅ Hiển thị thành công chi phái Nhì.`;

        } catch (err) {
            log.innerHTML = "❌ Lỗi kết nối mạng.";
            showError("Không thể kết nối với API. Hãy đảm bảo bạn đã 'Chia sẻ' Google Sheets ở chế độ 'Bất kỳ ai có liên kết đều có thể xem'.");
        }
    }

    function showError(msg) {
        document.getElementById('tree-container').innerHTML = `<div class="error-box"><h3>Phát hiện lỗi kỹ thuật</h3><p>${msg}</p></div>`;
    }

    function renderTree(data) {
        const width = Math.max(window.innerWidth, 1200);
        const height = data.length * 55 + 200;

        const svg = d3.select("#tree-container").append("svg")
            .attr("width", width).attr("height", height)
            .append("g").attr("transform", "translate(120, 50)");

        try {
            const stratify = d3.stratify()
                .id(d => d.id)
                .parentId(d => (d.parentId === "0" || d.parentId === "") ? null : d.parentId);

            const root = stratify(data);
            const treeLayout = d3.tree().size([height - 100, width - 450]);
            treeLayout(root);

            svg.selectAll(".link").data(root.links()).enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

            const node = svg.selectAll(".node").data(root.descendants()).enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.y},${d.x})`);

            node.append("circle").attr("r", 7);
            node.append("text")
                .attr("dy", "0.35em")
                .attr("x", d => d.children ? -15 : 15)
                .style("text-anchor", d => d.children ? "end" : "start")
                .text(d => d.data.name);
        } catch (e) {
            showError(`Dữ liệu phả đồ bị 'gãy': ${e.message}. <br><br> <b>Cách sửa:</b> Hãy kiểm tra xem có ai đó có Cha_ID trỏ về một ID không tồn tại không?`);
        }
    }

    init();
</script>
</body>
</html>
