<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Phan Đức - Chi Hai Phái Nhì</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #fcfaf7; }
        header { background: #8b0000; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #tree-container { width: 100%; height: 85vh; background: white; overflow: auto; }
        .node circle { fill: #fff; stroke-width: 2.5px; }
        /* Phân biệt màu sắc: Nam đỏ, Nữ (vợ) màu hồng/tím */
        .node-male circle { stroke: #8b0000; }
        .node-female circle { stroke: #ff69b4; } 
        .node text { font-size: 13px; font-weight: 600; }
        .link { fill: none; stroke: #d3d3d3; stroke-width: 1.5px; }
    </style>
</head>
<body>

<header><h1>Gia Phả Phan Đức - Chi Hai Phái Nhì</h1></header>
<div id="tree-container"></div>

<script>
    const SHEET_ID = "1H5Gi3MXAD6p9tywPmaiz4awtuETRKtK03cR_-bXeLVU";
    const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/giapha1`;

    async function init() {
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();

            const data = rawData.map(d => ({
                id: String(d.ID || "").trim(),
                parentId: String(d.Cha_ID || d.cha || "").trim(),
                name: d.Ho_va_Ten || d.ten || "Chưa rõ",
                isWife: String(d.ID).toUpperCase().endsWith('W')
            })).filter(d => d.id !== "");

            // Sửa lỗi Multiple Roots: Chỉ người đầu tiên được phép có parentId là null
            let rootId = data[0].id;
            const finalData = data.map((d, index) => {
                if (index === 0) {
                    d.parentId = null;
                } else if (d.parentId === "0" || d.parentId === "") {
                    // Nếu lỡ để trống hoặc 0 ở những người sau, tự động gắn vào gốc để không bị lỗi
                    d.parentId = rootId;
                }
                return d;
            });

            renderTree(finalData);
        } catch (err) {
            console.error(err);
        }
    }

    function renderTree(data) {
        const width = Math.max(window.innerWidth, 1200);
        const height = data.length * 50 + 200;
        const svg = d3.select("#tree-container").append("svg")
            .attr("width", width).attr("height", height)
            .append("g").attr("transform", "translate(150, 40)");

        const stratify = d3.stratify().id(d => d.id).parentId(d => d.parentId);
        const root = stratify(data);
        const treeLayout = d3.tree().size([height - 100, width - 450]);
        treeLayout(root);

        svg.selectAll(".link").data(root.links()).enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

        const node = svg.selectAll(".node").data(root.descendants()).enter().append("g")
            .attr("class", d => `node ${d.data.isWife ? 'node-female' : 'node-male'}`)
            .attr("transform", d => `translate(${d.y},${d.x})`);

        node.append("circle").attr("r", 6);
        node.append("text").attr("dy", "0.35em").attr("x", d => d.children ? -15 : 15)
            .style("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.isWife ? `(Bà) ${d.data.name}` : d.data.name);
    }

    init();
</script>
</body>
</html>

