<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Phan Đức - Chi Hai Phái Nhì</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; }
        #tree-container { width: 100%; height: 90vh; background: white; border: 1px solid #ccc; overflow: auto; }
        .node circle { fill: #fff; stroke: #8b0000; stroke-width: 3px; cursor: pointer; }
        .node text { font-size: 13px; font-weight: bold; }
        .link { fill: none; stroke: #8b0000; stroke-opacity: 0.4; stroke-width: 1.5px; }
    </style>
</head>
<body>
    <h2>Sơ Đồ Gia Phả Phan Đức (Chi Hai Phái Nhì)</h2>
    <div id="tree-container"></div>

    <script>
        // LINK API CỦA BẠN
        const SHEET_API = "https://opensheet.elk.sh/1bKYm6Mk9TzqreY-vFSfwBaJ9YxucRaee/giapha1";

        async function drawTree() {
            try {
                const response = await fetch(SHEET_API);
                const rawData = await response.json();

                if (!rawData || rawData.length === 0) {
                    document.body.innerHTML += "<p style='color:red'>Không tìm thấy dữ liệu trong Google Sheet!</p>";
                    return;
                }

                // CHUẨN HÓA DỮ LIỆU: Tự động tìm cột ID và Cha_ID bất kể viết hoa hay thường
                const data = rawData.map(d => {
                    const normalized = {};
                    for (let key in d) {
                        const lowKey = key.toLowerCase().trim();
                        if (lowKey === 'id') normalized.id = d[key];
                        if (lowKey === 'cha_id' || lowKey === 'cha') normalized.parentId = d[key];
                        if (lowKey === 'ho_va_ten' || lowKey === 'ten') normalized.name = d[key];
                    }
                    return normalized;
                });

                // Cấu trúc cây
                const stratify = d3.stratify()
                    .id(d => d.id)
                    .parentId(d => (d.parentId === "0" || d.parentId === "" || !d.parentId) ? null : d.parentId);

                const root = stratify(data);

                // Thiết lập kích thước
                const width = window.innerWidth;
                const height = data.length * 60; // Tự động kéo dài theo số người

                const svg = d3.select("#tree-container").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(150, 50)");

                const treeLayout = d3.tree().size([height - 100, width - 400]);
                treeLayout(root);

                // Vẽ đường nối
                svg.selectAll(".link")
                    .data(root.links())
                    .enter().append("path")
                    .attr("class", "link")
                    .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

                // Vẽ nút
                const node = svg.selectAll(".node")
                    .data(root.descendants())
                    .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", d => `translate(${d.y},${d.x})`);

                node.append("circle").attr("r", 8);
                node.append("text")
                    .attr("dy", ".35em")
                    .attr("x", d => d.children ? -15 : 15)
                    .style("text-anchor", d => d.children ? "end" : "start")
                    .text(d => d.data.name);

            } catch (error) {
                console.error("Lỗi:", error);
                document.body.innerHTML += `<p style='color:red'>Lỗi kết nối: ${error.message}</p>`;
            }
        }

        drawTree();
    </script>
</body>
</html>
