<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Phan Đức - Chi Hai Phái Nhì</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --primary-color: #8b0000; --bg-color: #fdfaf6; }
        body { font-family: 'Times New Roman', Times, serif; margin: 0; background: var(--bg-color); display: flex; flex-direction: column; height: 100vh; }
        
        /* Menu phía trên */
        nav { background: var(--primary-color); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .search-box { padding: 8px; border-radius: 20px; border: none; width: 250px; outline: none; }

        /* Vùng hiển thị chính */
        main { display: flex; flex: 1; overflow: hidden; }
        #tree-container { flex: 1; background: white; cursor: grab; position: relative; }
        
        /* Sidebar thông tin */
        #sidebar { width: 320px; background: white; border-left: 2px solid #eee; padding: 20px; box-shadow: -2px 0 5px rgba(0,0,0,0.05); overflow-y: auto; display: none; }
        .info-header { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px; }
        
        .node circle { stroke-width: 2px; transition: 0.3s; }
        .node-male circle { fill: #fff; stroke: var(--primary-color); }
        .node-female circle { fill: #fff; stroke: #ff69b4; }
        .node:hover circle { r: 10; fill: #ffeb3b; }
        .node text { font-size: 14px; font-weight: bold; }
        .link { fill: none; stroke: #ccc; stroke-width: 1.5px; }
    </style>
</head>
<body>

<nav>
    <div style="font-size: 1.2rem; font-weight: bold;">GIA PHẢ PHAN ĐỨC (CHI HAI PHÁI NHÌ)</div>
    <input type="text" class="search-box" placeholder="Tìm tên cụ (ví dụ: Mưu)..." oninput="searchName(this.value)">
</nav>

<main>
    <div id="tree-container"></div>
    <div id="sidebar">
        <div class="info-header"><h3 id="side-name">Thông tin chi tiết</h3></div>
        <p><b>Đời thứ:</b> <span id="side-generation"></span></p>
        <p><b>Ngày mất:</b> <span id="side-death"></span></p>
        <p><b>Nơi an táng:</b> <span id="side-burial"></span></p>
        <p><b>Ghi chú:</b> <div id="side-note" style="font-style: italic; color: #555;"></div></p>
    </div>
</main>

<script>
    const SHEET_ID = "1H5Gi3MXAD6p9tywPmaiz4awtuETRKtK03cR_-bXeLVU";
    const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/giapha1`;
    let allNodes = [];

    async function init() {
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();
            
            const data = rawData.map(d => {
                const row = {};
                for (let key in d) row[key.toLowerCase().trim()] = d[key];
                return {
                    id: String(d.ID || "").trim(),
                    parentId: String(d.Cha_ID || "").trim(),
                    name: (d.Ho_va_Ten || "Chưa rõ").trim(),
                    death: row['ngay_mat'] || "Không rõ",
                    burial: row['noi_an_tang'] || row['an_tang'] || "Chưa cập nhật",
                    note: row['ghi_chu'] || "Không có",
                    isWife: String(d.ID).toUpperCase().endsWith('W'),
                    doi: d.Doi || "?"
                };
            }).filter(d => d.id !== "");

            // Logic 1 gốc
            const finalData = data.map((d, i) => {
                if (i === 0) d.parentId = null;
                else if (!d.parentId || d.parentId === "0") d.parentId = data[0].id;
                return d;
            });

            renderTree(finalData);
        } catch (e) { console.error(e); }
    }

    function renderTree(data) {
        const width = 2000, height = data.length * 60;
        const svg = d3.select("#tree-container").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform)))
            .append("g");
        
        const g = svg.append("g").attr("transform", "translate(150, 50)");

        const stratify = d3.stratify().id(d => d.id).parentId(d => d.parentId);
        const root = stratify(data);
        const treeLayout = d3.tree().nodeSize([50, 250]);
        treeLayout(root);

        g.selectAll(".link").data(root.links()).enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

        const node = g.selectAll(".node").data(root.descendants()).enter().append("g")
            .attr("class", d => `node ${d.data.isWife ? 'node-female' : 'node-male'}`)
            .attr("transform", d => `translate(${d.y},${d.x})`)
            .on("click", (e, d) => showSidebar(d.data));

        node.append("circle").attr("r", 8);
        node.append("text").attr("dy", "0.35em").attr("x", d => d.children ? -15 : 15)
            .style("text-anchor", d => d.children ? "end" : "start")
            .text(d => (d.data.isWife ? "(Bà) " : "Ông ") + d.data.name);
        
        allNodes = node; // Lưu lại để tìm kiếm
    }

    function showSidebar(d) {
        document.getElementById('sidebar').style.display = 'block';
        document.getElementById('side-name').innerText = (d.isWife ? "(Bà) " : "Ông ") + d.name;
        document.getElementById('side-generation').innerText = d.doi;
        document.getElementById('side-death').innerText = d.death;
        document.getElementById('side-burial').innerText = d.burial;
        document.getElementById('side-note').innerText = d.note;
    }

    function searchName(val) {
        if (!val) { allNodes.style("opacity", 1); return; }
        allNodes.style("opacity", d => d.data.name.toLowerCase().includes(val.toLowerCase()) ? 1 : 0.1);
    }

    init();
</script>
</body>
</html>
